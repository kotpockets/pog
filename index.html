<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planogram Scanner (PWA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="icon-192.png" />
</head>
<body>
  <h2>Planogram Scanner (PWA)</h2>

  <video id="preview" playsinline></video>

  <button onclick="startScan('location')">Scan Location (QR)</button>
  <button onclick="startScan('product')">Scan Product (UPC/128)</button>

  <div id="output">
    <div><strong>Location:</strong> <span id="locationText">—</span></div>
    <div><strong>Product:</strong> <span id="productText">—</span></div>
    <br />
    <svg id="barcodeCanvas"></svg>
  </div>

  <h3>Recorded Entries</h3>
  <table id="recordsTable">
    <tr><th>Location</th><th>UPC</th></tr>
  </table>

  <button onclick="exportCSV()">Export CSV</button>

<!-- ZXing -->
<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.js"></script>

<!-- JsBarcode -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<script>
let currentScan = '';
let locationCode = '';
let productCode = '';

async function startScan(type) {
  console.log('StartScan triggered');
  console.log('navigator.mediaDevices:', navigator.mediaDevices);

  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert('❌ CAMERA API NOT AVAILABLE.');
    return;
  }

  console.log('ZXing:', window.ZXing);
  if (!window.ZXing || !window.ZXing.BrowserBarcodeReader) {
    alert('❌ ZXing failed to load.');
    return;
  }

  currentScan = type;
  const videoElem = document.getElementById('preview');
  const reader = new window.ZXing.BrowserBarcodeReader();

  try {
    await reader.decodeFromConstraints(
      { video: { facingMode: { ideal: 'environment' } } },
      videoElem,
      (result, err) => {
        if (result) {
          if (currentScan === 'location') {
            locationCode = result.text;
            document.getElementById('locationText').innerText = locationCode;
          } else {
            productCode = result.text.replace(/[^0-9A-Za-z]/g, '');
            document.getElementById('productText').innerText = productCode;
            drawBarcode(productCode);
            addRecord(locationCode, productCode);
          }
          reader.reset();
        }
      }
    );
  } catch (e) {
    alert('Camera Error: ' + e.message);
  }
}

function drawBarcode(code) {
  if (!code) return;
  JsBarcode('#barcodeCanvas', code, {
    format: code.length === 12 ? 'upc' : 'CODE128',
    width: 2,
    height: 100,
    displayValue: true
  });
}

function addRecord(loc, upc) {
  if (!loc || !upc) return;
  const table = document.getElementById('recordsTable');
  const row = table.insertRow(-1);
  row.insertCell(0).innerText = loc;
  row.insertCell(1).innerText = upc;
}

function exportCSV() {
  let csv = 'Location,UPC\n';
  const rows = document.querySelectorAll('#recordsTable tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const cols = row.querySelectorAll('td');
    csv += `${cols[0].innerText},${cols[1].innerText}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'planogram.csv';
  a.click();
}
</script>

</body>
</html>
