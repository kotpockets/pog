<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planogram Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Optional PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
    }
    h2 {
      margin-top: 0;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 6px 0;
      font-size: 16px;
    }
    #preview {
      width: 100%;
      max-height: 280px;
      background: #000;
      margin-top: 10px;
    }
    #product-scanner {
      width: 100%;
      max-height: 280px;
      background: #000;
      margin-top: 10px;
      position: relative;
      overflow: hidden;
    }
    #product-scanner video,
    #product-scanner canvas {
      width: 100%;
      height: auto;
    }
    .aim-box {
      position: absolute;
      top: 25%;
      left: 10%;
      width: 80%;
      height: 50%;
      border: 2px solid #00ff00;
      box-sizing: border-box;
      pointer-events: none;
    }
    #output {
      background: #fff;
      margin-top: 12px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      margin-top: 12px;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 14px;
      text-align: left;
      vertical-align: top;
    }
    .barcode-cell svg {
      width: 100%;
      max-width: 200px;
      height: 60px;
    }
  </style>
</head>
<body>

  <h2>Planogram Scanner</h2>

  <!-- Video for QR location scanning -->
  <video id="preview" playsinline style="display:none;"></video>

  <!-- Container for Quagga (product scanning) -->
  <div id="product-scanner" style="display:none;"></div>

  <button onclick="startLocationScan()">Scan Location (QR)</button>
  <button onclick="startProductScan()">Scan Product (UPC / Code128)</button>
  <button onclick="stopAllScanning()">Stop Scanning</button>

  <div id="output">
    <div><strong>Location:</strong> <span id="locationText">—</span></div>
    <div><strong>Product UPC:</strong> <span id="productText">—</span></div>
    <br />
    <div><strong>Re-scannable Product Barcode:</strong></div>
    <svg id="barcodeCanvas"></svg>
  </div>

  <h3>Recorded Entries</h3>
  <table id="recordsTable">
    <tr>
      <th>Location</th>
      <th>UPC</th>
      <th>Barcode (for re-scan)</th>
    </tr>
  </table>

  <button onclick="exportCSV()">Export CSV</button>

  <!-- ZXing (for QR location) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.min.js"></script>

  <!-- Quagga2 (for UPC/Code128 products) -->
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

  <!-- JsBarcode (for drawing barcodes) -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <script>
    let locationCode = "";
    let productCode = "";

    let zxingReader = null;      // ZXing reader for QR
    let quaggaRunning = false;   // Quagga state
    let handlingProduct = false; // lock while handling a detection

    let lastProductCode = null;  // for stability (double-pass)
    let lastProductTime = 0;

    /* ----------------------------------------------------
       Utility: Stop all scanning
    -----------------------------------------------------*/
    function stopAllScanning() {
      stopLocationScan();
      stopProductScan();
    }

    function stopLocationScan() {
      if (zxingReader) {
        try { zxingReader.reset(); } catch (e) {}
        zxingReader = null;
      }
      const video = document.getElementById("preview");
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      video.style.display = "none";
    }

    function stopProductScan() {
      if (quaggaRunning) {
        Quagga.stop();
        quaggaRunning = false;
      }
      const container = document.getElementById("product-scanner");
      container.style.display = "none";
      container.innerHTML = "";
      handlingProduct = false;
      lastProductCode = null;
      lastProductTime = 0;
    }

    /* ----------------------------------------------------
       LOCATION SCAN (QR via ZXing)
    -----------------------------------------------------*/
    async function startLocationScan() {
      stopProductScan(); // no conflicts

      const videoElem = document.getElementById("preview");
      videoElem.style.display = "block";
      document.getElementById("product-scanner").style.display = "none";

      if (!window.ZXing || !window.ZXing.BrowserMultiFormatReader) {
        alert("ZXing did not load.");
        return;
      }

      // ZXing QR-only hints for stability
      const hints = new Map();
      hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [ZXing.BarcodeFormat.QR_CODE]);

      zxingReader = new ZXing.BrowserMultiFormatReader(hints);

      try {
        await zxingReader.decodeFromVideoDevice(
          null,
          videoElem,
          (result, err) => {
            if (result) {
              locationCode = result.text;
              document.getElementById("locationText").innerText = locationCode;
              stopLocationScan();
              alert("Location captured. Now scan product.");
            }
          }
        );
      } catch (e) {
        alert("Location camera error: " + e.message);
      }
    }

    /* ----------------------------------------------------
       PRODUCT SCAN (UPC/Code128 via Quagga, continuous)
    -----------------------------------------------------*/
    function startProductScan() {
      stopLocationScan();

      const container = document.getElementById("product-scanner");
      const videoElem = document.getElementById("preview");
      videoElem.style.display = "none";
      container.style.display = "block";
      container.innerHTML = "";

      // Add aiming box overlay
      const aim = document.createElement("div");
      aim.className = "aim-box";
      container.appendChild(aim);

      if (!locationCode) {
        if (!confirm("No location scanned yet. Continue anyway?")) {
          return;
        }
      }

      if (quaggaRunning) return;

      handlingProduct = false;
      lastProductCode = null;
      lastProductTime = 0;

      Quagga.init(
        {
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: container,
            constraints: {
              facingMode: "environment",
              width: { ideal: 1920 },
              height: { ideal: 1080 }
            }
          },
          locator: {
            patchSize: "x-large",   // better for UPC
            halfSample: false       // more accurate
          },
          numOfWorkers: 4,
          decoder: {
            readers: [
              "upc_reader",
              "upc_e_reader",
              "ean_reader",
              "code_128_reader",
              "code_39_reader"
            ],
            debug: {
              drawBoundingBox: true,
              showFrequency: false,
              drawScanline: false,
              showPattern: false
            }
          },
          locate: true,
          frequency: 10
        },
        function (err) {
          if (err) {
            console.error(err);
            alert("Product scanner error: " + err.message);
            return;
          }
          Quagga.start();
          quaggaRunning = true;

          Quagga.offDetected(onProductDetected);
          Quagga.onDetected(onProductDetected);
        }
      );
    }

    function onProductDetected(result) {
      if (handlingProduct) return;

      if (!result || !result.codeResult || !result.codeResult.code) {
        return;
      }

      const code = result.codeResult.code;
      const decoded = result.codeResult.decodedCodes || [];

      // Basic validity: length check (UPC or typical Code128 range)
      if (!(code.length === 12 || (code.length >= 6 && code.length <= 30))) {
        return;
      }

      // Confidence filtering: average error
      if (decoded.length > 0) {
        let sumErr = 0;
        let count = 0;
        decoded.forEach(c => {
          if (c && typeof c.error === "number") {
            sumErr += c.error;
            count++;
          }
        });
        const avgErr = count ? sumErr / count : 1.0;
        // Lower avgErr = better; reject high-error reads
        if (avgErr > 0.15) {
          return;
        }
      }

      const now = Date.now();

      // Double-pass stability: require same code twice in ~1.5s
      if (code !== lastProductCode) {
        lastProductCode = code;
        lastProductTime = now;
        return; // wait for a second confirming read
      } else {
        if (now - lastProductTime > 1500) {
          // too long between reads, treat as new
          lastProductCode = code;
          lastProductTime = now;
          return;
        }
      }

      // If we reach here, we have a stable code
      handlingProduct = true;

      productCode = code;
      document.getElementById("productText").innerText = productCode;

      drawBarcode(productCode);
      addRecord(locationCode || "(none)", productCode);

      stopProductScan();
      alert("Product captured.");
    }

    /* ----------------------------------------------------
       RENDER PRODUCT BARCODE (for re-scan)
    -----------------------------------------------------*/
    function drawBarcode(code) {
      try {
        JsBarcode("#barcodeCanvas", code, {
          format: code.length === 12 ? "upc" : "CODE128",
          height: 80,
          displayValue: true
        });
      } catch (e) {
        console.error("Barcode render error:", e);
      }
    }

    /* ----------------------------------------------------
       TABLE & CSV
    -----------------------------------------------------*/
    function addRecord(loc, upc) {
      const table = document.getElementById("recordsTable");
      const row = table.insertRow(-1);

      const locCell = row.insertCell(0);
      const upcCell = row.insertCell(1);
      const barcodeCell = row.insertCell(2);

      locCell.innerText = loc;
      upcCell.innerText = upc;

      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      barcodeCell.classList.add("barcode-cell");
      barcodeCell.appendChild(svg);

      try {
        JsBarcode(svg, upc, {
          format: upc.length === 12 ? "upc" : "CODE128",
          height: 40,
          displayValue: false
        });
      } catch (e) {
        console.error("Row barcode render error:", e);
      }
    }

    function exportCSV() {
      let csv = "Location,UPC\n";
      const rows = document.querySelectorAll("#recordsTable tr");
      rows.forEach((row, i) => {
        if (i === 0) return; // skip header
        const cols = row.querySelectorAll("td");
        if (cols.length >= 2) {
          csv += `${cols[0].innerText},${cols[1].innerText}\n`;
        }
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "planogram.csv";
      a.click();
    }
  </script>
</body>
</html>
