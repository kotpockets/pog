<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planogram Scanner (PWA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- PWA meta (browser + iOS) -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <!-- ZXing (CORRECT version, same as before but without .1) -->
  <script src="https://unpkg.com/@zxing/library@0.18.6"></script>

  <!-- JsBarcode -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    h2 {
      margin-top: 0;
    }
    button {
      width: 100%;
      padding: 15px;
      margin-top: 12px;
      font-size: 18px;
      border-radius: 4px;
      border: 1px solid #444;
      background: #f4f4f4;
    }
    button:active {
      background: #e0e0e0;
    }
    video {
      width: 100%;
      margin-top: 15px;
      border: 1px solid #ccc;
      min-height: 150px;
      background: #000;
    }
    #output {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      min-height: 80px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Planogram Scanner (PWA)</h2>

  <video id="preview" playsinline></video>

  <button onclick="startScan('location')">Scan Location (QR)</button>
  <button onclick="startScan('product')">Scan Product (UPC/128)</button>

  <div id="output">
    <div><strong>Location:</strong> <span id="locationText">â€”</span></div>
    <div><strong>Product:</strong> <span id="productText">â€”</span></div>
    <br />
    <svg id="barcodeCanvas"></svg>
  </div>

  <h3>Recorded Entries</h3>
  <table id="recordsTable">
    <tr><th>Location</th><th>UPC</th></tr>
  </table>

  <button onclick="exportCSV()">Export CSV</button>

  <script>
    // Register service worker (hybrid caching)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('service-worker.js')
          .catch(err => console.error('SW registration failed:', err));
      });
    }

    // App logic
    let currentScan = '';
    let locationCode = '';
    let productCode = '';

    async function startScan(type) {
      console.log('StartScan triggered');

      // Camera API availability
      console.log('navigator.mediaDevices:', navigator.mediaDevices);
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('âŒ CAMERA API NOT AVAILABLE.\nYour browser or device is blocking camera access.');
        return;
      }

      // ZXing availability
      console.log('ZXing:', window.ZXing);
      if (!window.ZXing || !window.ZXing.BrowserBarcodeReader) {
        alert('âŒ ZXing failed to load.');
        return;
      }

      currentScan = type;
      const videoElem = document.getElementById('preview');

      const reader = new window.ZXing.BrowserBarcodeReader();

      console.log('ðŸ“¸ Attempting to start cameraâ€¦');

      try {
        await reader.decodeFromConstraints(
          {
            video: {
              facingMode: { ideal: 'environment' } // back camera where possible
            }
          },
          videoElem,
          (result, err) => {
            if (result) {
              console.log('ðŸ“¦ Scan result:', result.text);

              if (currentScan === 'location') {
                locationCode = result.text;
                document.getElementById('locationText').innerText = locationCode;
              } else {
                productCode = result.text.replace(/[^0-9A-Za-z]/g, '');
                document.getElementById('productText').innerText = productCode;
                drawBarcode(productCode);
                addRecord(locationCode, productCode);
              }

              reader.reset();
            }
          }
        );
      } catch (e) {
        console.error('Camera Error:', e);
        alert('âŒ CAMERA ERROR:\n' + e.message);
      }
    }

    function drawBarcode(code) {
      if (!code) return;
      JsBarcode('#barcodeCanvas', code, {
        format: code.length === 12 ? 'upc' : 'CODE128',
        width: 2,
        height: 100,
        displayValue: true
      });
    }

    function addRecord(loc, upc) {
      if (!loc || !upc) return;
      const table = document.getElementById('recordsTable');
      const row = table.insertRow(-1);
      row.insertCell(0).innerText = loc;
      row.insertCell(1).innerText = upc;
    }

    function exportCSV() {
      let csv = 'Location,UPC\n';
      const rows = document.querySelectorAll('#recordsTable tr');
      rows.forEach((row, i) => {
        if (i === 0) return;
        const cols = row.querySelectorAll('td');
        csv += `${cols[0].innerText},${cols[1].innerText}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'planogram.csv';
      a.click();
    }
  </script>
</body>
</html>
