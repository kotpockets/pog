<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planogram Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- (Optional PWA manifest, safe to leave) -->
  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f4f4f4;
    }
    h2 {
      margin-top: 0;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 6px 0;
      font-size: 16px;
    }
    #preview, #product-scanner {
      width: 100%;
      max-height: 280px;
      background: #000;
      margin-top: 10px;
    }
    #product-scanner {
      position: relative;
    }
    #output {
      background: #fff;
      margin-top: 12px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      margin-top: 12px;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 14px;
      text-align: left;
    }
    .barcode-cell svg {
      width: 100%;
      max-width: 200px;
      height: 60px;
    }
  </style>
</head>
<body>

  <h2>Planogram Scanner</h2>

  <!-- Shared video for QR (location) -->
  <video id="preview" playsinline style="display:none;"></video>

  <!-- Container used by Quagga for product barcodes -->
  <div id="product-scanner" style="display:none;"></div>

  <button onclick="startLocationScan()">Scan Location (QR)</button>
  <button onclick="startProductScan()">Scan Product (UPC / Code128)</button>
  <button onclick="stopAllScanning()">Stop Scanning</button>

  <div id="output">
    <div><strong>Location:</strong> <span id="locationText">—</span></div>
    <div><strong>Product UPC:</strong> <span id="productText">—</span></div>
    <br />
    <div><strong>Re-scannable Product Barcode:</strong></div>
    <svg id="barcodeCanvas"></svg>
  </div>

  <h3>Recorded Entries</h3>
  <table id="recordsTable">
    <tr>
      <th>Location</th>
      <th>UPC</th>
      <th>Barcode (for re-scan)</th>
    </tr>
  </table>

  <button onclick="exportCSV()">Export CSV</button>

  <!-- ZXing for QR (location) -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.18.6/umd/index.js"></script>

  <!-- Quagga2 for UPC / Code128 -->
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

  <!-- JsBarcode for rendering product barcodes -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <script>
    let locationCode = "";
    let productCode = "";

    // ZXing reader for location QR
    let zxingReader = null;

    // Quagga state
    let quaggaRunning = false;
    let handlingProduct = false; // prevent double triggers

    /* ----------------------------------------------------
       Utility: Stop all scanning & camera streams
    -----------------------------------------------------*/
    function stopAllScanning() {
      stopLocationScan();
      stopProductScan();
    }

    function stopLocationScan() {
      if (zxingReader) {
        try { zxingReader.reset(); } catch (e) {}
        zxingReader = null;
      }
      const video = document.getElementById("preview");
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      video.style.display = "none";
    }

    function stopProductScan() {
      if (quaggaRunning) {
        Quagga.stop();
        quaggaRunning = false;
      }
      const container = document.getElementById("product-scanner");
      container.style.display = "none";
      container.innerHTML = "";
      handlingProduct = false;
    }

    /* ----------------------------------------------------
       LOCATION SCAN (QR via ZXing)
    -----------------------------------------------------*/
    async function startLocationScan() {
      stopProductScan();

      const videoElem = document.getElementById("preview");
      videoElem.style.display = "block";
      document.getElementById("product-scanner").style.display = "none";

      if (!window.ZXing || !window.ZXing.BrowserMultiFormatReader) {
        alert("ZXing did not load.");
        return;
      }

      zxingReader = new ZXing.BrowserMultiFormatReader();

      try {
        await zxingReader.decodeFromVideoDevice(
          null,
          videoElem,
          (result, err) => {
            if (result) {
              locationCode = result.text;
              document.getElementById("locationText").innerText = locationCode;
              // stop after one scan
              stopLocationScan();
              alert("Location captured. Now scan product.");
            }
          }
        );
      } catch (e) {
        alert("Location camera error: " + e.message);
      }
    }

    /* ----------------------------------------------------
       PRODUCT SCAN (UPC/Code128 via Quagga, continuous)
    -----------------------------------------------------*/
    function startProductScan() {
      stopLocationScan();  // ensure no conflict

      const container = document.getElementById("product-scanner");
      const videoElem = document.getElementById("preview");
      videoElem.style.display = "none";
      container.style.display = "block";
      container.innerHTML = ""; // Quagga will insert its own video

      if (!locationCode) {
        if (!confirm("No location scanned yet. Continue anyway?")) {
          return;
        }
      }

      if (quaggaRunning) {
        return; // already running
      }

      handlingProduct = false;

      Quagga.init(
        {
          inputStream: {
            name: "Live",
            type: "LiveStream",
            target: container,
            constraints: {
              facingMode: "environment"
            }
          },
          locator: {
            patchSize: "medium",
            halfSample: true
          },
          decoder: {
            readers: [
              "upc_reader",
              "upc_e_reader",
              "ean_reader",
              "code_128_reader",
              "code_39_reader"
            ]
          },
          locate: true
        },
        function (err) {
          if (err) {
            console.error(err);
            alert("Product scanner error: " + err.message);
            return;
          }
          Quagga.start();
          quaggaRunning = true;
        }
      );

      Quagga.offDetected(onProductDetected); // ensure not added twice
      Quagga.onDetected(onProductDetected);
    }

    function onProductDetected(result) {
      if (handlingProduct) return; // prevent double-handling
      handlingProduct = true;

      if (!result || !result.codeResult || !result.codeResult.code) {
        handlingProduct = false;
        return;
      }

      const code = result.codeResult.code;

      // Basic sanity: ignore ultra-short garbage
      if (code.length < 6) {
        handlingProduct = false;
        return;
      }

      productCode = code;
      document.getElementById("productText").innerText = productCode;

      // Draw the re-scannable product barcode
      drawBarcode(productCode);

      // Add to table (even if location missing, we record)
      addRecord(locationCode || "(none)", productCode);

      // Stop scanning after a successful read
      stopProductScan();
      alert("Product captured.");
    }

    /* ----------------------------------------------------
       RENDER PRODUCT BARCODE (for re-scan)
    -----------------------------------------------------*/
    function drawBarcode(code) {
      try {
        JsBarcode("#barcodeCanvas", code, {
          format: code.length === 12 ? "upc" : "CODE128",
          height: 80,
          displayValue: true
        });
      } catch (e) {
        console.error("Barcode render error:", e);
      }
    }

    /* ----------------------------------------------------
       TABLE & CSV
    -----------------------------------------------------*/
    function addRecord(loc, upc) {
      const table = document.getElementById("recordsTable");
      const row = table.insertRow(-1);

      const locCell = row.insertCell(0);
      const upcCell = row.insertCell(1);
      const barcodeCell = row.insertCell(2);

      locCell.innerText = loc;
      upcCell.innerText = upc;

      // Create an SVG barcode inside the cell
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      barcodeCell.classList.add("barcode-cell");
      barcodeCell.appendChild(svg);

      try {
        JsBarcode(svg, upc, {
          format: upc.length === 12 ? "upc" : "CODE128",
          height: 40,
          displayValue: false
        });
      } catch (e) {
        console.error("Row barcode render error:", e);
      }
    }

    function exportCSV() {
      let csv = "Location,UPC\n";
      const rows = document.querySelectorAll("#recordsTable tr");
      rows.forEach((row, i) => {
        if (i === 0) return; // skip header
        const cols = row.querySelectorAll("td");
        if (cols.length >= 2) {
          csv += `${cols[0].innerText},${cols[1].innerText}\n`;
        }
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "planogram.csv";
      a.click();
    }
  </script>
</body>
</html>
